import sys

#session
reg_session_stream = ''.join(chr(x) for x in [0x65, 0x0, # Register session
0x4, 0x0, # Length
0x0, 0x0, 0x0, 0x0, # Session handle
0x0, 0x0, 0x0, 0x0, # Status
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, # Sender context
0x1, 0x0, 0x0, 0x0]) # Command specific data
#getAttrsingle 4/<instance>/3

instance=130
if len(sys.argv) > 1: instance = int(sys.argv[1])

print 'Instance:4/',instance,'/3'
get_attr1_stream = ''.join(chr(x) for x in [0x6f, 0x0,
0x18, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, # Interface Handle CIP
0x0, 0x0, # Timeout
0x2, # Item Count
0x0, 0x0, 0x0, 0x0, 0x0, 0xb2, 0x0, 0x8, 0x0, 0xe, 0x3, 0x20, 0x4, 0x24, instance, 0x30, 0x3]) #getAttrsingle 4/129/3

set_attr1_stream = ''.join(chr(x) for x in [0x6f, 0x0,
0xa4, 0x1, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, # Interface Handle CIP
0x0, 0x0, # Timeout
0x2, # Item Count
0x0, 0x0, 0x0, 0x0, 0x0, 0xb2, 0x0, 0x94, 0x1, 0x10, 0x3, 0x20, 0x4, 0x24, instance, 0x30, 0x3]) #getAttrsingle 4/129/3

# Echo client program
import socket,time,threading,signal,select,struct

HOST = '172.24.1.67'    # The remote host
PORT = 44818              # The same port as used by the server
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

print 'Connecting'
s.connect((HOST, PORT))
# ch = sys.stdin.read(1)
# print 'ch:',ch
# if ch == 'q': sys.exit(0)

print 'About to register session'
s.send(reg_session_stream)
data = s.recv(1024)
# print 'reg_session_resp(',len(data),'):', [hex(ord(c)) for c in data ]
# ch = sys.stdin.read(1)
# print 'ch:',ch
# if ch == 'q': sys.exit(0)

print 'About to set attribute'
s.send(set_attr1_stream + '0'*396)
data = s.recv(1024)
#print 'Received2', repr(data)
print 'Received2(',len(data),'):', [hex(ord(c)) for c in data ]
# ch = sys.stdin.read(1)
# print 'ch:',ch
# if ch == 'q': sys.exit(0)

# if len(data) > 44:
    # #print '4/',instance,'/3:', [hex(ord(c)) for c in data[44:] ]
    # vars = struct.unpack('ii'+'f'*96 + 'hh', data[44:])
    # print vars
# else:
    # print 'ERROR(',len(data),'):', [hex(ord(c)) for c in data ]
